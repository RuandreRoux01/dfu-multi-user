<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFU Demand Transfer Management - Multi User</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script>
        // Prevent the original app from auto-initializing
        window.preventAutoInit = true;
    </script>
</head>
<body class="bg-gray-100">
    <!-- Session Login Modal -->
    <div id="sessionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96">
            <h2 class="text-xl font-bold mb-4">Join or Create Session</h2>
            <input type="text" id="sessionName" placeholder="Session Name" class="w-full mb-3 p-2 border rounded">
            <input type="text" id="userName" placeholder="Your Name" class="w-full mb-3 p-2 border rounded">
            <button id="joinSessionBtn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" onclick="handleJoinSession()">
                Join Session
            </button>
        </div>
    </div>
    
    <!-- Active Users Panel -->
    <div id="activeUsersPanel" class="fixed right-4 top-4 bg-white rounded-lg shadow-lg p-4 w-64 hidden z-40">
        <h3 class="font-semibold mb-2">Active Users</h3>
        <div id="activeUsersList"></div>
    </div>
    
    <!-- Main App Container -->
    <div id="app"></div>
    
    <script src="script.js"></script>
    <script>
        // Global variables
        let appInstance = null;
        let sessionId = null;
        let userName = null;
        let socket = null;
        
        async function handleJoinSession() {
            console.log('handleJoinSession called');
            
            const sessionNameInput = document.getElementById('sessionName').value.trim();
            const userNameInput = document.getElementById('userName').value.trim();
            
            if (!sessionNameInput || !userNameInput) {
                alert('Please enter both session name and your name');
                return;
            }
            
            const joinBtn = document.getElementById('joinSessionBtn');
            joinBtn.disabled = true;
            joinBtn.textContent = 'Joining...';
            
            try {
                // Call the API to join session
                const response = await fetch('/api/session/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sessionName: sessionNameInput, 
                        userName: userNameInput 
                    })
                });
                
                const data = await response.json();
                console.log('Join response:', data);
                
                if (data.success) {
                    sessionId = data.sessionId;
                    userName = userNameInput;
                    
                    // Hide modal
                    document.getElementById('sessionModal').style.display = 'none';
                    
                    // Show active users panel
                    document.getElementById('activeUsersPanel').classList.remove('hidden');
                    
                    // Initialize the app if not already initialized
                    if (!appInstance) {
                        console.log('Creating new DemandTransferApp instance');
                        appInstance = new DemandTransferApp();
                    }
                    
                    // Set up multi-user features
                    setupMultiUserFeatures();
                    
                    // Load session data
                    loadSessionData();
                }
            } catch (error) {
                console.error('Error joining session:', error);
                alert('Failed to join session: ' + error.message);
                joinBtn.disabled = false;
                joinBtn.textContent = 'Join Session';
            }
        }
        
        function setupMultiUserFeatures() {
            if (!appInstance) return;
            
            // Connect WebSocket
            socket = io();
            
            socket.on('connect', () => {
                console.log('WebSocket connected');
                socket.emit('joinSession', { sessionId, userName });
            });
            
            socket.on('userJoined', ({ userName: newUser }) => {
                console.log('User joined:', newUser);
                if (appInstance.showNotification) {
                    appInstance.showNotification(`${newUser} joined the session`, 'info');
                }
            });
            
            socket.on('activeUsers', (users) => {
                const usersList = document.getElementById('activeUsersList');
                if (usersList) {
                    usersList.innerHTML = users.map(u => `<div class="text-sm py-1">${u}</div>`).join('');
                }
            });
            
            socket.on('dataUploaded', () => {
                console.log('Data uploaded by another user');
                if (appInstance.showNotification) {
                    appInstance.showNotification('Another user uploaded data', 'info');
                }
                loadSessionData();
            });
            
            socket.on('dataUpdated', ({ dfuCode, updatedBy }) => {
                console.log('Data updated by another user:', updatedBy);
                if (updatedBy !== userName) {
                    if (appInstance.showNotification) {
                        appInstance.showNotification(`${updatedBy} completed transfer for DFU ${dfuCode}`, 'info');
                    }
                    // Reload data to get the latest changes
                    loadSessionData();
                }
            });
            
            // Override loadData method - upload file and let client process it
            const originalLoadData = appInstance.loadData.bind(appInstance);
            appInstance.loadData = async function(file) {
                console.log('Multi-user loadData');
                
                this.isLoading = true;
                this.render();
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch(`/api/upload/${sessionId}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification(`Successfully uploaded ${result.rowCount} records`);
                        await loadSessionData();
                    } else {
                        this.showNotification('Failed to upload file', 'error');
                    }
                } catch (error) {
                    console.error('Error uploading:', error);
                    this.showNotification('Upload failed', 'error');
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            };
            
            // DON'T override executeTransfer - let it work normally on client side
            // Just save the modified data after execution
            const originalExecuteTransfer = appInstance.executeTransfer.bind(appInstance);
            appInstance.executeTransfer = function(dfuCode) {
                console.log('Executing transfer with original logic');
                
                // Execute with original logic (this modifies this.rawData)
                originalExecuteTransfer(dfuCode);
                
                // After execution, save the modified rawData to server
                setTimeout(() => {
                    console.log('Saving modified data to server after transfer');
                    
                    // Save the entire modified dataset back to server
                    fetch(`/api/session/${sessionId}/updateData`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            rawData: this.rawData,
                            transfer: {
                                dfuCode,
                                type: this.bulkTransfers[dfuCode] ? 'bulk' : 
                                      (this.granularTransfers[dfuCode] && Object.keys(this.granularTransfers[dfuCode]).length > 0) ? 'granular' : 
                                      'individual',
                                targetVariant: this.bulkTransfers[dfuCode],
                                transfers: this.transfers[dfuCode],
                                granularTransfers: this.granularTransfers[dfuCode],
                                completedBy: userName
                            }
                        })
                    }).then(response => response.json())
                      .then(data => {
                          console.log('Data saved to server:', data);
                          this.showNotification('Transfer completed and saved', 'success');
                      })
                      .catch(error => {
                          console.error('Error saving data:', error);
                          this.showNotification('Transfer completed locally but failed to save to server', 'warning');
                      });
                }, 500);
            };
            
            // Override exportData method - just download the current rawData
            appInstance.exportData = async function() {
                console.log('Multi-user exportData');
                
                try {
                    // Use the original export logic to format dates properly
                    const formattedData = this.rawData.map(record => {
                        const formattedRecord = { ...record };
                        
                        // Format Calendar.week if it exists
                        if (formattedRecord['Calendar.week']) {
                            const dateValue = formattedRecord['Calendar.week'];
                            if (dateValue) {
                                const date = new Date(dateValue);
                                if (!isNaN(date.getTime())) {
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    formattedRecord['Calendar.week'] = `${year}-${month}-${day}`;
                                }
                            }
                        }
                        
                        return formattedRecord;
                    });
                    
                    // Send formatted data to server for export
                    const response = await fetch(`/api/session/${sessionId}/export`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            rawData: formattedData
                        })
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `DFU_Transfers_${sessionId}_${Date.now()}.xlsx`;
                        a.click();
                        this.showNotification('File exported successfully');
                    }
                } catch (error) {
                    console.error('Error exporting:', error);
                    this.showNotification('Export failed', 'error');
                }
            };
        }
        
        async function loadSessionData() {
            if (!appInstance || !sessionId) return;
            
            try {
                const response = await fetch(`/api/session/${sessionId}/data`);
                const data = await response.json();
                
                if (data.rawData && data.rawData.length > 0) {
                    appInstance.rawData = data.rawData;
                    appInstance.originalRawData = JSON.parse(JSON.stringify(data.rawData));
                    appInstance.processMultiVariantDFUs(data.rawData);
                    appInstance.isProcessed = true;
                    appInstance.render();
                }
            } catch (error) {
                console.error('Error loading session data:', error);
            }
        }
        
        // Modify the DemandTransferApp to not auto-initialize
        document.addEventListener('DOMContentLoaded', function() {
            // The app will be created only after joining a session
            console.log('DOM ready, waiting for session join...');
        });
    </script>
</body>
</html>