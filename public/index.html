<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFU Transfer Management - Team Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        #notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        
        .notification-enter {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        #mainContent {
            padding-right: 280px;
        }
        
        #activeUsersPanel {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 250px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        @media (max-width: 1024px) {
            #mainContent {
                padding-right: 20px;
            }
            
            #activeUsersPanel {
                position: relative;
                right: auto;
                top: auto;
                width: 100%;
                margin-bottom: 20px;
            }
        }
    </style>
    <script>
        window.preventAutoInit = true;
    </script>
</head>
<body class="bg-gray-100">
    <!-- Simple Login - Just enter your name -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96">
            <h2 class="text-xl font-bold mb-4">Join Team Session</h2>
            <input type="text" id="userName" placeholder="Enter your name" class="w-full mb-3 p-2 border rounded">
            <button id="joinBtn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" onclick="joinTeam()">
                Join Team
            </button>
        </div>
    </div>
    
    <!-- Notifications -->
    <div id="notifications"></div>
    
    <!-- Active Users Panel -->
    <div id="activeUsersPanel" class="bg-white rounded-lg shadow-lg p-4 hidden z-40">
        <h3 class="font-semibold mb-2">Active Team Members</h3>
        <div id="activeUsersList" class="mb-4 text-sm"></div>
        <button onclick="clearAllData()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 text-sm">
            Clear All Data
        </button>
    </div>
    
    <!-- Main App -->
    <div id="mainContent">
        <div id="app"></div>
    </div>
    
    <script src="script.js"></script>
    <script>
        // Global variables
        let appInstance = null;
        let userName = null;
        let socket = null;
        let notificationCount = 0;
        let originalRawDataBackup = null;
        
        // Fixed session ID - always the same
        const TEAM_SESSION_ID = 'TEAM_DFU_TRANSFER_SESSION';
        
        async function joinTeam() {
            const userNameInput = document.getElementById('userName').value.trim();
            
            if (!userNameInput) {
                alert('Please enter your name');
                return;
            }
            
            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = true;
            joinBtn.textContent = 'Joining...';
            
            try {
                const response = await fetch('/api/session/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userName: userNameInput })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    userName = userNameInput;
                    
                    // Hide login modal
                    document.getElementById('loginModal').style.display = 'none';
                    
                    // Show active users panel
                    document.getElementById('activeUsersPanel').classList.remove('hidden');
                    
                    // Initialize app
                    if (!appInstance) {
                        appInstance = new DemandTransferApp();
                    }
                    
                    // Setup features
                    setupFeatures();
                    
                    // Load data
                    loadTeamData();
                    
                    showNotification(`Welcome ${userName}!`, 'success');
                }
            } catch (error) {
                console.error('Error joining:', error);
                alert('Failed to join team');
                joinBtn.disabled = false;
                joinBtn.textContent = 'Join Team';
            }
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            const id = `notification-${++notificationCount}`;
            notification.id = id;
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            notification.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg notification-enter`;
            notification.innerHTML = `<span>${message}</span>`;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) el.remove();
            }, 5000);
        }
        
        function preserveScrollPosition(callback) {
            const dfuListContainer = document.querySelector('.space-y-2.h-full.overflow-y-auto');
            const scrollTop = dfuListContainer ? dfuListContainer.scrollTop : 0;
            
            callback();
            
            setTimeout(() => {
                if (dfuListContainer) {
                    dfuListContainer.scrollTop = scrollTop;
                }
            }, 50);
        }
        
        function setupFeatures() {
            // Connect WebSocket
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
                socket.emit('joinSession', { userName });
            });
            
            socket.on('userJoined', ({ userName: newUser }) => {
                if (newUser !== userName) {
                    showNotification(`${newUser} joined the team`, 'info');
                }
            });
            
            socket.on('activeUsers', (users) => {
                const usersList = document.getElementById('activeUsersList');
                if (usersList) {
                    usersList.innerHTML = users.map(u => `
                        <div class="text-sm py-1 flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                            ${u}
                        </div>
                    `).join('');
                }
            });
            
            socket.on('dataUploaded', ({ uploadedBy }) => {
                if (uploadedBy !== userName) {
                    showNotification(`${uploadedBy} uploaded new data`, 'info');
                    loadTeamData();
                }
            });
            
            socket.on('cycleDataUploaded', ({ uploadedBy }) => {
                if (uploadedBy !== userName) {
                    showNotification(`${uploadedBy} uploaded cycle dates`, 'info');
                    loadTeamData();
                }
            });
            
            socket.on('dataUpdated', ({ dfuCode, updatedBy }) => {
                if (updatedBy !== userName) {
                    showNotification(`${updatedBy} updated DFU ${dfuCode}`, 'info');
                    loadTeamData();
                }
            });
            
            socket.on('transferUndone', ({ dfuCode, undoneBy, remainingTransfers }) => {
                if (undoneBy !== userName) {
                    showNotification(`${undoneBy} undid transfer for DFU ${dfuCode}`, 'warning');
        
                    // Update the local state to reflect the undo
                    if (appInstance && appInstance.completedTransfers) {
                        delete appInstance.completedTransfers[dfuCode];
                        delete appInstance.transfers[dfuCode];
                        delete appInstance.bulkTransfers[dfuCode];
                        delete appInstance.granularTransfers[dfuCode];
                        
                        // If we have remaining transfers, update them
                        if (remainingTransfers) {
                            appInstance.completedTransfers = remainingTransfers;
                        }
                        
                        // Reload data to ensure sync
                        loadTeamData();
                    }
                }
            });

            // Enhanced loadTeamData function
            async function loadTeamData() {
                if (!appInstance) return;
                
                try {
                    const response = await fetch('/api/session/data');
                    const data = await response.json();
                    
                    if (data.rawData && data.rawData.length > 0) {
                        appInstance.rawData = data.rawData;
                        appInstance.originalRawData = JSON.parse(JSON.stringify(data.rawData));
                        originalRawDataBackup = JSON.parse(JSON.stringify(data.rawData));
                        
                        // Properly sync completed transfers from DB
                        if (data.completedTransfers) {
                            appInstance.completedTransfers = data.completedTransfers;
                            
                            // Mark DFUs as completed in the UI
                            Object.keys(data.completedTransfers).forEach(dfuCode => {
                                if (!appInstance.transfers) appInstance.transfers = {};
                                appInstance.transfers[dfuCode] = true;
                            });
                        }
                        
                        if (data.variantCycleData) {
                            appInstance.variantCycleDates = data.variantCycleData;
                            appInstance.hasVariantCycleData = true;
                        }
                        
                        preserveScrollPosition(() => {
                            appInstance.processMultiVariantDFUs(data.rawData);
                            appInstance.isProcessed = true;
                            appInstance.render();
                        });
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            // Enhanced undo function
            appInstance.undoTransfer = async function(dfuCode) {
                try {
                    const response = await fetch('/api/undoTransfer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ dfuCode, userName })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        // Restore original data
                        if (originalRawDataBackup) {
                            this.rawData = JSON.parse(JSON.stringify(originalRawDataBackup));
                        }
                        
                        // Clear local transfer state
                        delete this.completedTransfers[dfuCode];
                        delete this.transfers[dfuCode];
                        delete this.bulkTransfers[dfuCode];
                        delete this.granularTransfers[dfuCode];
                        
                        // Update with remaining transfers from server
                        if (result.remainingTransfers) {
                            this.completedTransfers = result.remainingTransfers;
                        }
                        
                        this.processMultiVariantDFUs(this.rawData);
                        
                        showNotification('Transfer undone successfully', 'success');
                        
                        preserveScrollPosition(() => {
                            this.render();
                        });
                        
                        // Reload to ensure full sync
                        setTimeout(() => loadTeamData(), 500);
                    }
                } catch (error) {
                    showNotification('Failed to undo transfer', 'error');
                    console.error('Undo error:', error);
                }
            };
            
            socket.on('dataCleared', ({ clearedBy }) => {
                showNotification(`${clearedBy} cleared all data`, 'warning');
                window.location.reload();
            });
            
            // Override app methods for simplified API
            appInstance.loadData = async function(file) {
                this.isLoading = true;
                this.render();
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('userName', userName);
                
                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification(`Uploaded ${result.rowCount} records`, 'success');
                        await loadTeamData();
                    } else {
                        showNotification('Upload failed', 'error');
                    }
                } catch (error) {
                    showNotification('Upload error: ' + error.message, 'error');
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            };
            
            appInstance.loadVariantCycleData = async function(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('userName', userName);
                
                try {
                    const response = await fetch('/api/upload-cycle', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification(`Uploaded cycle dates for ${result.dfuCount} DFUs`, 'success');
                        await loadTeamData();
                    }
                } catch (error) {
                    showNotification('Cycle upload failed', 'error');
                }
            };
            
            const originalExecuteTransfer = appInstance.executeTransfer.bind(appInstance);
            appInstance.executeTransfer = function(dfuCode) {
                originalExecuteTransfer(dfuCode);
                
                setTimeout(() => {
                    fetch('/api/updateData', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            rawData: this.rawData,
                            completedTransfers: this.completedTransfers || {},
                            transfer: {
                                dfuCode,
                                type: this.bulkTransfers[dfuCode] ? 'bulk' : 'individual',
                                completedBy: userName
                            }
                        })
                    }).then(() => {
                        showNotification('Transfer saved', 'success');
                    });
                }, 500);
            };
            
            appInstance.undoTransfer = async function(dfuCode) {
                try {
                    await fetch('/api/undoTransfer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ dfuCode, userName })
                    });
                    
                    if (originalRawDataBackup) {
                        this.rawData = JSON.parse(JSON.stringify(originalRawDataBackup));
                    }
                    
                    delete this.completedTransfers[dfuCode];
                    delete this.transfers[dfuCode];
                    delete this.bulkTransfers[dfuCode];
                    delete this.granularTransfers[dfuCode];
                    
                    this.processMultiVariantDFUs(this.rawData);
                    
                    showNotification('Transfer undone', 'success');
                    
                    preserveScrollPosition(() => {
                        this.render();
                    });
                    
                    // Update server with restored data
                    await fetch('/api/updateData', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            rawData: this.rawData,
                            completedTransfers: this.completedTransfers || {},
                            transfer: {
                                dfuCode,
                                type: 'undo',
                                completedBy: userName
                            }
                        })
                    });
                } catch (error) {
                    showNotification('Undo failed', 'error');
                }
            };
            
            appInstance.exportData = async function() {
                try {
                    const formattedData = this.rawData.map(record => {
                        const formatted = { ...record };
                        if (formatted['Calendar.week']) {
                            const date = new Date(formatted['Calendar.week']);
                            if (!isNaN(date.getTime())) {
                                formatted['Calendar.week'] = date.toISOString().split('T')[0];
                            }
                        }
                        return formatted;
                    });
                    
                    const response = await fetch('/api/export', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rawData: formattedData })
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `DFU_Transfers_${Date.now()}.xlsx`;
                        a.click();
                        showNotification('Export successful', 'success');
                    }
                } catch (error) {
                    showNotification('Export failed', 'error');
                }
            };
            
            const originalSelectDFU = appInstance.selectDFU.bind(appInstance);
            appInstance.selectDFU = function(dfuCode) {
                preserveScrollPosition(() => {
                    originalSelectDFU(dfuCode);
                });
            };
            
            appInstance.showNotification = showNotification;
        }
        
        async function loadTeamData() {
            if (!appInstance) return;
            
            try {
                const response = await fetch('/api/session/data');
                const data = await response.json();
                
                if (data.rawData && data.rawData.length > 0) {
                    appInstance.rawData = data.rawData;
                    appInstance.originalRawData = JSON.parse(JSON.stringify(data.rawData));
                    originalRawDataBackup = JSON.parse(JSON.stringify(data.rawData));
                    
                    if (data.completedTransfers) {
                        appInstance.completedTransfers = data.completedTransfers;
                    }
                    
                    if (data.variantCycleData) {
                        appInstance.variantCycleDates = data.variantCycleData;
                        appInstance.hasVariantCycleData = true;
                    }
                    
                    preserveScrollPosition(() => {
                        appInstance.processMultiVariantDFUs(data.rawData);
                        appInstance.isProcessed = true;
                        appInstance.render();
                    });
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        async function clearAllData() {
            if (!confirm('Clear all data? This cannot be undone.')) return;
            
            try {
                await fetch('/api/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userName })
                });
                
                showNotification('All data cleared', 'warning');
                setTimeout(() => window.location.reload(), 1000);
            } catch (error) {
                showNotification('Failed to clear data', 'error');
            }
        }
    </script>
</body>
</html>